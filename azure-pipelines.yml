trigger:
- feature

pool:
  name: 'ubuntu'

variables:
  SNYK_TOKEN: $(SNYK_TOKEN)  # Make sure to add this variable in your pipeline settings

parameters:
- name: runSAST
  type: boolean
  default: true
  displayName: 'Run SAST Scan'

- name: runSCA
  type: boolean
  default: true
  displayName: 'Run SCA Scan'

- name: runIaC
  type: boolean
  default: true
  displayName: 'Run IaC Scan'

stages:
- stage: Scan
  jobs:
  - job: SnykScans
    steps:
    - task: UseNode@1
      inputs:
        versionSpec: '14.x'
        checkLatest: true

    - script: npm install -g snyk
      displayName: 'Install Snyk CLI'

    - script: snyk auth $(SNYK_TOKEN)
      displayName: 'Authenticate Snyk'

    - ${{ if parameters.runSAST }}:
      - script: snyk code test --severity-threshold=high --fail-on=all
        displayName: 'Snyk Code Test (SAST)'

    - ${{ if parameters.runSCA }}:
      - script: snyk test --json >sca_repot.json
        displayName: 'Snyk Test (SCA)'

    - ${{ if parameters.runIaC }}:
      - script: snyk iac test >iac_report.json --report
        displayName: 'Snyk IaC Test'

    - script: snyk monitor
      displayName: 'Snyk Monitor'
