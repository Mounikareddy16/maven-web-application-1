trigger:
- feature

pool:
  name: 'ubuntu'

variables:
  SNYK_TOKEN: $(snykApiToken)

steps:
- task: UseNode@1
  inputs:
    version: '16.x'
    
- script: npm install -g snyk
  displayName: 'Install Snyk CLI'

- script: snyk auth $(SNYK_TOKEN)
  displayName: 'Authenticate Snyk CLI'
  
- script: snyk code test --severity-threshold=high --fail-on=all 
  displayName: 'Run Snyk SAST Scan'

- script: snyk test --json >sca_report.json
  displayName: 'Snyk Test (SCA)'

- script: snyk iac test >iac_report.json --report
  displayName: 'Snyk IaC Test'

- script: snyk monitor
  displayName: 'Snyk Monitor'